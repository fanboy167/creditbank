{% extends 'base.html' %}
{% block title %}บทเรียน: {{ lesson.lesson_name }}{% endblock %}

{% block content %}
{% include "component/header.html" %}

<div class="container-fluid bg-primary py-5 mb-5 page-header">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 text-center">
                <h1 class="display-3 text-white animated slideInDown">{{ lesson.lesson_name }}</h1>
            </div>
        </div>
    </div>
</div>

<div class="container-xxl py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card p-4 shadow-sm">
                    {% if lesson_contents %}
                        {% for content in lesson_contents %}
                            <div class="mb-4">
                                <h5><i class="fa fa-video text-primary me-2"></i>{{ content.title }}</h5>
                                
                                <div class="ratio ratio-16x9 mb-3">
                                    <iframe id="youtube-player-{{ content.video_id }}"
                                            src="https://www.youtube.com/embed/{{ content.youtube_link.split('v=')[-1].split('&')[0] }}?enablejsapi=1" 
                                            frameborder="0" 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                            allowfullscreen>
                                    </iframe>
                                </div>

                                <div id="status-{{ content.video_id }}">
                                    {% if content.video_id in completed_video_ids %}
                                        <span class="badge bg-success"><i class="fas fa-check-circle"></i> ดูจบแล้ว</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="fas fa-eye"></i> ยังไม่ได้ดู</span>
                                    {% endif %}
                                </div>
                            </div>
                            <hr>
                        {% endfor %}
                    {% else %}
                        <p>ยังไม่มีเนื้อหาสำหรับบทเรียนนี้</p>
                    {% endif %}
                    
                    <div class="mt-4 text-center">
                        <a href="{{ url_for('user_learning_path', course_id=course.id) }}" class="btn btn-secondary px-4">กลับสู่เส้นทางการเรียนรู้</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "component/footer.html" %}
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
    // 1. โหลด YouTube Iframe Player API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var players = {};

    // 2. ฟังก์ชันนี้จะถูกเรียกเมื่อ API พร้อมใช้งาน
    function onYouTubeIframeAPIReady() {
        $('iframe[id^="youtube-player-"]').each(function() {
            var iframeId = $(this).attr('id');
            players[iframeId] = new YT.Player(iframeId, {
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        });
    }

    // 3. ฟังก์ชันนี้จะถูกเรียกเมื่อสถานะวิดีโอเปลี่ยน (เช่น เล่น, หยุด, จบ)
    function onPlayerStateChange(event) {
        // ตรวจสอบว่าวิดีโอเล่นจบแล้ว (State 0 คือจบ)
        if (event.data === YT.PlayerState.ENDED) {
            var iframe = event.target.getIframe();
            var videoId = iframe.id.replace('youtube-player-', '');
            
            // ส่งข้อมูลไปบันทึกที่เซิร์ฟเวอร์
            markVideoAsComplete(videoId);
        }
    }

    // 4. ฟังก์ชันสำหรับส่ง AJAX Request ไปยัง Flask
    function markVideoAsComplete(videoId) {
        console.log("วิดีโอ ID: " + videoId + " เล่นจบแล้ว กำลังส่งข้อมูล...");
        
        $.ajax({
            url: "{{ url_for('mark_video_as_watched_auto') }}", // เรียกใช้ Endpoint ใหม่
            type: 'POST',
            data: {
                video_id: videoId
            },
            success: function(response) {
                if (response.status === 'success') {
                    console.log("บันทึกสำเร็จ!");
                    // อัปเดต UI ทันที
                    $('#status-' + videoId).html('<span class="badge bg-success"><i class="fas fa-check-circle"></i> ดูจบแล้ว</span>');
                } else {
                    console.error('เกิดข้อผิดพลาดในการบันทึก: ' + response.message);
                }
            },
            error: function(xhr) {
                console.error('AJAX error:', xhr.responseText);
            }
        });
    }
</script>
{% endblock %}