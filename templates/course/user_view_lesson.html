{# templates/course/user_view_lesson.html #}
{% extends 'base.html' %}

{% block title %}{{ lesson.lesson_name }}{% endblock %}

{% block content %}
{% include "component/header.html" %}

<!-- Header Start -->
<div class="container-fluid bg-primary py-5 mb-5 page-header">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 text-center">
                <h1 class="display-3 text-white animated slideInDown">{{ lesson.lesson_name }}</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a class="text-white" href="{{ url_for('home') }}">Home</a></li>
                        <li class="breadcrumb-item"><a class="text-white" href="{{ url_for('course_detail', course_id=course.id) }}">{{ course.title }}</a></li>
                        <li class="breadcrumb-item text-white active" aria-current="page">{{ lesson.lesson_name }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- Header End -->

<div class="container py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <h2 class="mb-4">{{ lesson.lesson_name }}</h2>
            <p class="lead">{{ lesson.description }}</p>
            <hr class="my-4">

            {# Loop แสดงเนื้อหาบทเรียน #}
            {% if lesson_contents %}
                {% for content in lesson_contents %}
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ content.title }}</h5>
                            
                            {% if content.youtube_link %}
                                <div class="ratio ratio-16x9 mb-3">
                                    <div id="player-{{ content.video_id }}" 
                                         class="youtube-player" 
                                         data-video-id="{{ content.video_id }}" 
                                         data-youtube-url="{{ content.youtube_link }}">
                                    </div>
                                </div>
                            {% else %}
                                <video controls 
                                       class="img-fluid rounded track-progress"
                                       data-video-id="{{ content.video_id }}">
                                    <source src="{{ url_for('static', filename='course_videos/' ~ content.featured_video) }}" type="video/mp4">
                                    เบราว์เซอร์ของคุณไม่รองรับแท็กวิดีโอ
                                </video>
                            {% endif %}
                            
                            <p class="card-text mt-3">{{ content.description }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">ยังไม่มีเนื้อหาสำหรับบทเรียนนี้</div>
            {% endif %}

            <div class="text-center mt-4">
                <a href="{{ url_for('user_learning_path', course_id=course.id) }}" class="btn btn-primary"><i class="fas fa-arrow-left me-2"></i>กลับไปยังเส้นทางการเรียนรู้</a>
            </div>
        </div>
    </div>
</div>

{% include "component/footer.html" %}
{% endblock %}


{% block scripts %}
<script src="https://www.youtube.com/iframe_api"></script>
<script>
var players = {}; 

function onYouTubeIframeAPIReady() {
    const youtubePlayersDivs = document.querySelectorAll('.youtube-player');
    
    youtubePlayersDivs.forEach(div => {
        const videoId = div.dataset.videoId;
        const youtubeUrl = div.dataset.youtubeUrl;
        const youtubeId = extractYouTubeId(youtubeUrl);
        const divId = div.getAttribute('id');

        if (youtubeId && divId) {
            players[videoId] = new YT.Player(divId, {
                height: '100%',
                width: '100%',
                videoId: youtubeId,
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }
    });
}

// --- VVVVVV แก้ไขฟังก์ชันนี้ทั้งหมด VVVVVV ---
function onPlayerStateChange(event) {
    // YT.PlayerState.ENDED คือสถานะที่วิดีโอเล่นจบ (ค่าคือ 0)
    if (event.data == YT.PlayerState.ENDED) {
        let videoId = null;
        
        // วนลูปหาว่า player object (event.target) ที่ส่งสัญญาณมา
        // ตรงกับ videoId ตัวไหนที่เราเก็บไว้ใน players object
        for (const id in players) {
            if (players[id] === event.target) {
                videoId = id;
                break;
            }
        }
        
        if (videoId) {
            markVideoAsCompleted(videoId);
        } else {
            console.error("Could not find a matching videoId for the player that ended.");
        }
    }
}
// --- ^^^^^^ สิ้นสุดการแก้ไข ^^^^^^ ---

function extractYouTubeId(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function markVideoAsCompleted(videoId) {
    console.log(`SUCCESS: Video ID: ${videoId} has ended. Sending progress to server...`);
    const url = `/mark_video_completed/${videoId}`;

    fetch(url, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('SUCCESS: Progress saved successfully.');
        } else {
            console.error('ERROR: Failed to save progress:', data.message);
        }
    })
    .catch(error => {
        console.error('ERROR: Error sending video progress:', error);
    });
}

// โค้ดสำหรับวิดีโอที่อัปโหลดเอง
document.addEventListener('DOMContentLoaded', function() {
    const videos = document.querySelectorAll('video.track-progress');
    videos.forEach(video => {
        const videoId = video.dataset.videoId;
        if (!videoId) return;
        video.addEventListener('ended', function() {
            markVideoAsCompleted(videoId);
        });
    });
});
</script>
{% endblock %}
